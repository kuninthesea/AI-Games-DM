# TRPG游戏云服务器部署指南

## 概述
本指南将帮助您将TRPG游戏从局域网环境部署到云服务器，实现公网访问。

---

## 第一步：选择云服务器

### 推荐的云服务商
1. **阿里云 ECS**
   - 优点：国内访问速度快，文档详细
   - 价格：约 ¥50-100/月（1核2GB）
   - 适合：国内用户

2. **腾讯云 CVM**
   - 优点：价格便宜，新用户优惠大
   - 价格：约 ¥30-80/月（1核2GB）
   - 适合：国内用户

3. **华为云 ECS**
   - 优点：稳定性好，企业级服务
   - 价格：约 ¥40-90/月（1核2GB）
   - 适合：对稳定性要求高的用户

4. **AWS EC2**（海外）
   - 优点：全球覆盖，功能强大
   - 价格：约 $10-20/月
   - 适合：国际用户

5. **Vultr/DigitalOcean**（海外）
   - 优点：价格便宜，配置简单
   - 价格：约 $5-10/月
   - 适合：预算有限的用户

### 推荐配置
- **CPU**: 1-2核
- **内存**: 2-4GB
- **存储**: 20-40GB SSD
- **网络**: 1-5Mbps 带宽
- **操作系统**: Ubuntu 20.04 LTS 或 CentOS 7/8

---

## 第二步：购买和配置云服务器

### 2.1 购买服务器
1. 注册云服务商账号
2. 选择实例规格（建议1核2GB起步）
3. 选择操作系统（推荐Ubuntu 20.04）
4. 配置网络和安全组
5. 设置登录密钥或密码

### 2.2 配置安全组/防火墙
**需要开放的端口：**
- `22` - SSH管理端口
- `80` - HTTP端口（可选，用于域名访问）
- `443` - HTTPS端口（可选，用于SSL）
- `3000` - 前端服务端口
- `5000` - 后端API端口

**安全组规则示例（阿里云）：**
```
规则方向 | 协议类型 | 端口范围 | 授权对象    | 描述
入方向   | TCP     | 22      | 0.0.0.0/0  | SSH管理
入方向   | TCP     | 3000    | 0.0.0.0/0  | 前端服务
入方向   | TCP     | 5000    | 0.0.0.0/0  | 后端API
入方向   | TCP     | 80      | 0.0.0.0/0  | HTTP（可选）
入方向   | TCP     | 443     | 0.0.0.0/0  | HTTPS（可选）
```

---

## 第三步：服务器环境准备

### 3.1 连接到服务器
```bash
# 使用SSH连接（替换为您的服务器IP）
ssh root@your_server_ip

# 或使用密钥文件
ssh -i your_key.pem ubuntu@your_server_ip
```

### 3.2 更新系统
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 3.3 安装必要软件
```bash
# 安装Python 3.9+
sudo apt install python3 python3-pip python3-venv git -y

# 安装Node.js（如果需要）
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装Nginx（用于反向代理，可选）
sudo apt install nginx -y

# 安装supervisor（用于进程管理）
sudo apt install supervisor -y
```

---

## 第四步：部署游戏代码

### 4.1 上传代码到服务器
**方法1：使用Git（推荐）**
```bash
# 在服务器上克隆代码
git clone https://your_repository_url.git AIGame
cd AIGame
```

**方法2：使用SCP上传**
```bash
# 在本地执行
scp -r D:\AIGame root@your_server_ip:/home/
```

**方法3：使用FTP工具**
- 使用FileZilla、WinSCP等工具上传文件

### 4.2 安装Python依赖
```bash
cd /home/AIGame

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 如果没有requirements.txt，手动安装
pip install flask openai google-generativeai requests
```

---

## 第五步：配置应用

### 5.1 修改配置文件
创建生产环境配置文件：
```python
# config_prod.py
import os

# 服务器配置
HOST = '0.0.0.0'  # 监听所有接口
BACKEND_PORT = 5000
FRONTEND_PORT = 3000

# API配置
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY', 'your_api_key')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY', 'your_api_key')

# 数据库配置
DATABASE_PATH = '/home/AIGame/backend/game_data.db'

# 安全配置
SECRET_KEY = os.getenv('SECRET_KEY', 'your_very_long_secret_key_here')
```

### 5.2 设置环境变量
```bash
# 创建环境变量文件
nano /home/AIGame/.env

# 添加以下内容：
export OPENAI_API_KEY="your_openai_api_key"
export GEMINI_API_KEY="your_gemini_api_key"
export SECRET_KEY="your_very_long_secret_key_here"
export FLASK_ENV="production"
```

---

## 第六步：配置进程管理

### 6.1 使用Supervisor管理进程
创建Supervisor配置：
```bash
sudo nano /etc/supervisor/conf.d/trpg_game.conf
```

配置内容：
```ini
[program:trpg_backend]
command=/home/AIGame/venv/bin/python /home/AIGame/backend/app.py
directory=/home/AIGame
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/trpg_backend.log
environment=PATH="/home/AIGame/venv/bin"

[program:trpg_frontend]
command=/home/AIGame/venv/bin/python /home/AIGame/frontend/app.py
directory=/home/AIGame
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/trpg_frontend.log
environment=PATH="/home/AIGame/venv/bin"
```

启动服务：
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start all
```

### 6.2 检查服务状态
```bash
sudo supervisorctl status
```

---

## 第七步：配置Nginx反向代理（可选但推荐）

### 7.1 创建Nginx配置
```bash
sudo nano /etc/nginx/sites-available/trpg_game
```

配置内容：
```nginx
server {
    listen 80;
    server_name your_domain.com;  # 替换为您的域名或服务器IP

    # 前端静态文件
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端API
    location /api/ {
        proxy_pass http://localhost:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket支持（如果需要）
    location /socket.io/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 7.2 启用配置
```bash
sudo ln -s /etc/nginx/sites-available/trpg_game /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

---

## 第八步：域名配置（可选）

### 8.1 购买域名
- 阿里云万网
- 腾讯云DNS
- GoDaddy
- Namecheap

### 8.2 配置DNS解析
添加A记录：
```
类型: A
主机记录: @（或www）
记录值: your_server_ip
TTL: 600
```

### 8.3 配置SSL证书（推荐）
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取免费SSL证书
sudo certbot --nginx -d your_domain.com

# 自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

---

## 第九步：监控和日志

### 9.1 查看应用日志
```bash
# Supervisor日志
sudo tail -f /var/log/trpg_backend.log
sudo tail -f /var/log/trpg_frontend.log

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 系统日志
sudo journalctl -f -u nginx
```

### 9.2 监控系统资源
```bash
# 查看CPU和内存使用
htop

# 查看磁盘空间
df -h

# 查看网络连接
netstat -tulpn
```

---

## 第十步：备份和安全

### 10.1 数据备份
创建备份脚本：
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/home/backups"
mkdir -p $BACKUP_DIR

# 备份数据库
cp /home/AIGame/backend/*.db $BACKUP_DIR/game_data_$DATE.db

# 备份用户数据
tar -czf $BACKUP_DIR/userdata_$DATE.tar.gz /home/AIGame/userdata/

# 删除7天前的备份
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

设置定时备份：
```bash
crontab -e
# 添加：0 2 * * * /home/backup.sh
```

### 10.2 安全加固
```bash
# 禁用root SSH登录（可选）
sudo nano /etc/ssh/sshd_config
# PermitRootLogin no

# 配置防火墙
sudo ufw enable
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 3000
sudo ufw allow 5000

# 定期更新系统
sudo apt update && sudo apt upgrade -y
```

---

## 访问测试

部署完成后，通过以下方式访问：
- **直接IP访问**: `http://your_server_ip:3000`
- **域名访问**: `http://your_domain.com`
- **HTTPS访问**: `https://your_domain.com`

---

## 常见问题解决

### 1. 端口被占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep :5000
# 或
sudo lsof -i :5000

# 杀死进程
sudo kill -9 PID
```

### 2. 权限问题
```bash
# 修改文件权限
sudo chown -R www-data:www-data /home/AIGame
sudo chmod -R 755 /home/AIGame
```

### 3. 数据库权限
```bash
# 确保数据库文件可写
sudo chmod 666 /home/AIGame/backend/*.db
sudo chmod 777 /home/AIGame/backend/  # 目录权限
```

### 4. 服务启动失败
```bash
# 查看详细错误
sudo supervisorctl tail -f trpg_backend stderr
sudo supervisorctl tail -f trpg_frontend stderr

# 手动测试启动
cd /home/AIGame
source venv/bin/activate
python backend/app.py
```

---

## 成本估算

### 基础配置（1核2GB）
- **阿里云**: ¥50-80/月
- **腾讯云**: ¥30-60/月
- **Vultr**: $5-10/月
- **域名**: ¥50-100/年
- **SSL证书**: 免费（Let's Encrypt）

### 总成本
- **国内**: 约 ¥400-1000/年
- **海外**: 约 $60-120/年

---

## 性能优化建议

1. **使用CDN加速静态资源**
2. **开启Nginx gzip压缩**
3. **配置Redis缓存（如需要）**
4. **数据库优化和索引**
5. **监控工具部署（如Grafana）**

---

## 总结

按照以上步骤，您就能成功将TRPG游戏部署到云服务器上。部署过程中遇到问题时，可以参考日志文件进行排查，或者联系云服务商的技术支持。

建议先从基础配置开始，随着用户增长再逐步升级服务器配置和优化性能。
